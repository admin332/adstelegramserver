

## –ó–∞–¥–∞—á–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ä–µ–∫–ª–∞–º—ã –≤ –∫–∞–Ω–∞–ª—ã –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ + –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (—Å—Ç–∞—Ç—É—Å `in_progress`) **–±–æ—Ç –ù–ï –ø—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç** –≤ –∫–∞–Ω–∞–ª. –ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è:
1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–µ `scheduled_at`
2. –ü—É–±–ª–∏–∫—É–µ—Ç —Ä–µ–∫–ª–∞–º—É –≤ –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ Telegram Bot API
3. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `completed` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
```
id: a802c68d-..., status: in_progress, scheduled_at: 2026-01-27 00:00:00+00
```
–°–¥–µ–ª–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞, –Ω–æ –ø–æ—Å—Ç –Ω–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω.

## –†–µ—à–µ–Ω–∏–µ

### –ß–∞—Å—Ç—å 1: Edge Function –¥–ª—è –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏

–°–æ–∑–¥–∞—Ç—å `supabase/functions/publish-scheduled-posts/index.ts`:

1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–¥–µ–ª–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `in_progress` –≥–¥–µ `scheduled_at <= now()`
2. –î–ª—è –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏:
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ (—Ç–µ–∫—Å—Ç, –º–µ–¥–∏–∞, –∫–Ω–æ–ø–∫–∞)
   - –ü—É–±–ª–∏–∫—É–µ—Ç –≤ –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ `telegram_chat_id`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `posted_at = now()`, `status = 'completed'`
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

### –ß–∞—Å—Ç—å 2: Cron job –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞

–î–æ–±–∞–≤–∏—Ç—å pg_cron –∑–∞–¥–∞—á—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ `publish-scheduled-posts` –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É:

```sql
select cron.schedule(
  'publish-scheduled-posts',
  '* * * * *',
  $$
  select net.http_post(
    url:='https://fdxyittddmpyhaiijddp.supabase.co/functions/v1/publish-scheduled-posts',
    headers:='{"Content-Type": "application/json", "Authorization": "Bearer <anon_key>"}'::jsonb,
    body:='{}'::jsonb
  ) as request_id;
  $$
);
```

### –ß–∞—Å—Ç—å 3: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

–û–±–Ω–æ–≤–∏—Ç—å `AdminDealsTable.tsx`:

1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É "–ü—É–±–ª–∏–∫–∞—Ü–∏—è" —Å —Ç–µ–∫—É—â–∏–º `scheduled_at`
2. –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
3. –°–æ–∑–¥–∞—Ç—å `ScheduleEditDialog` —Å DateTimePicker
4. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å `scheduled_at` –≤ –±–∞–∑–µ

## –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|------|----------|
| `supabase/functions/publish-scheduled-posts/index.ts` | –°–æ–∑–¥–∞—Ç—å ‚Äî –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –∫–∞–Ω–∞–ª—ã |
| `supabase/config.toml` | –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é |
| `src/components/admin/AdminDealsTable.tsx` | –û–±–Ω–æ–≤–∏—Ç—å ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã |
| `src/components/admin/ScheduleEditDialog.tsx` | –°–æ–∑–¥–∞—Ç—å ‚Äî –¥–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã |

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. publish-scheduled-posts/index.ts

```typescript
// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–¥–µ–ª–∫–∏: status = 'in_progress' AND scheduled_at <= NOW()
2. –î–ª—è –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏:
   - –ü–æ–ª—É—á–∏—Ç—å channel.telegram_chat_id
   - –ü–æ–ª—É—á–∏—Ç—å campaign (text, media_urls, button_text, button_url)
   - –í—ã–∑–≤–∞—Ç—å Telegram API –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:
     * sendPhoto/sendVideo –¥–ª—è –æ–¥–Ω–æ–≥–æ –º–µ–¥–∏–∞
     * sendMediaGroup –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ–¥–∏–∞
     * sendMessage –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ –º–µ–¥–∏–∞
   - –û–±–Ω–æ–≤–∏—Ç—å deal: posted_at = now(), status = 'completed'
   - –£–≤–µ–¥–æ–º–∏—Ç—å —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è: "–í–∞—à–∞ —Ä–µ–∫–ª–∞–º–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –≤ –∫–∞–Ω–∞–ª–µ X"
```

### 2. –õ–æ–≥–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∫–∞–Ω–∞–ª

```typescript
async function publishToChannel(chatId: number, campaign: Campaign) {
  const replyMarkup = button_text && button_url 
    ? { inline_keyboard: [[{ text: button_text, url: button_url }]] }
    : undefined;

  if (!media_urls?.length) {
    await sendMessage(chatId, text, replyMarkup);
  } else if (media_urls.length === 1) {
    await sendPhoto/sendVideo(chatId, media_urls[0], text, replyMarkup);
  } else {
    await sendMediaGroup(chatId, media_urls, text);
    if (replyMarkup) await sendMessage(chatId, "üëÜ", replyMarkup);
  }
}
```

### 3. AdminDealsTable ‚Äî –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞

–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É:
- –ö–æ–ª–æ–Ω–∫–∞ "–ü—É–±–ª–∏–∫–∞—Ü–∏—è" –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∞—è `scheduled_at`
- –ö–Ω–æ–ø–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π Calendar –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è `ScheduleEditDialog`

```typescript
<TableHead>–ü—É–±–ª–∏–∫–∞—Ü–∏—è</TableHead>
...
<TableCell>
  <div className="flex items-center gap-2">
    <span>{formatScheduledAt(deal.scheduled_at)}</span>
    <Button size="icon" variant="ghost" onClick={() => openEditDialog(deal)}>
      <CalendarIcon className="h-4 w-4" />
    </Button>
  </div>
</TableCell>
```

### 4. ScheduleEditDialog

```typescript
interface ScheduleEditDialogProps {
  deal: AdminDeal;
  open: boolean;
  onClose: () => void;
  onSave: (dealId: string, newDate: Date) => void;
}

// –°–æ–¥–µ—Ä–∂–∏—Ç:
// - Calendar –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
// - Select –¥–ª—è –≤—ã–±–æ—Ä–∞ —á–∞—Å–∞
// - –ö–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" / "–û—Ç–º–µ–Ω–∞"
```

### 5. –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –≤ AdminDealsTable

–î–æ–±–∞–≤–∏—Ç—å `scheduled_at` –≤ SELECT:

```typescript
.select(`
  id, status, total_price, posts_count, duration_hours,
  escrow_address, created_at, expires_at, scheduled_at,  // <-- –¥–æ–±–∞–≤–∏—Ç—å
  channel:channels(title, username),
  ...
`)
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
1. **–ê–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏—è**: –ë–æ—Ç –ø—É–±–ª–∏–∫—É–µ—Ç —Ä–µ–∫–ª–∞–º—É –≤ –∫–∞–Ω–∞–ª –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ `scheduled_at`
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
3. **–ö–æ–Ω—Ç—Ä–æ–ª—å**: –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä—è–º–æ –≤ –ø–∞–Ω–µ–ª–∏
4. **–°—Ç–∞—Ç—É—Å—ã**: –°–¥–µ–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ `completed` –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:
```
üì¢ –í–∞—à–∞ —Ä–µ–∫–ª–∞–º–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!

–ö–∞–Ω–∞–ª: Channel Name (@username)
–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: 27.01.2026 –≤ 03:00

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Adsingo!
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω –∫–∞–Ω–∞–ª–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É, –Ω–µ –º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å
- –ï—Å–ª–∏ –º–µ–¥–∏–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Üí –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –±–µ–∑ –º–µ–¥–∏–∞
- Retry logic –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ Telegram API

