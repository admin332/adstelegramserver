

## Исправление проверки оплаты (баланс меньше из-за комиссии)

Проблема найдена! Рекламодатель отправил 1 TON, но из-за сетевой комиссии на кошелёк пришло только 0.999999999 TON. Система ждёт ровно 1 TON и не засчитывает оплату.

---

## Диагностика

| Параметр | Значение |
|----------|----------|
| Deal ID | `2e24a604-90e6-4c56-bb47-3c326a024c61` |
| Эскроу-адрес | `UQDpBC1gh8MC8Gcx0iAAJbvibtCx5AeBKjSlmwZoY9canrei` |
| Требуемая сумма | 1 TON |
| Фактический баланс | 0.999999999 TON |
| Разница | ~0.000000001 TON (комиссия сети) |

---

## Решение

Добавить допуск (tolerance) на сетевую комиссию при проверке оплаты.

### Изменение в `supabase/functions/check-escrow-payments/index.ts`

**Текущая логика (строка 485):**

```typescript
if (balanceNano >= requiredNano) {
```

**Новая логика с допуском ~1%:**

```typescript
// Allow 1% tolerance for network fees
const tolerance = requiredNano * 0.01;

if (balanceNano >= (requiredNano - tolerance)) {
```

---

## Почему 1%?

- Комиссия TON обычно ~0.01-0.05 TON
- При сделке в 1 TON: допуск = 0.01 TON
- При сделке в 10 TON: допуск = 0.1 TON
- Это покрывает любые стандартные комиссии сети

---

## Результат

После исправления:
- Баланс: 0.999999999 TON
- Требуется: 1 TON
- Допуск: 0.01 TON
- Проверка: 0.999999999 >= (1 - 0.01) = 0.999999999 >= 0.99 = **TRUE**

Оплата будет засчитана автоматически при следующей проверке (каждые 5 минут).

