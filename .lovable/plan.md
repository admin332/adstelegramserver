

# –û—Ç–º–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ä–µ–¥—Å—Ç–≤

## –ó–∞–¥–∞—á–∞

–ö–æ–≥–¥–∞ –∞–¥–º–∏–Ω –≤—Ä—É—á–Ω—É—é –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ –Ω–∞ "–û—Ç–º–µ–Ω–µ–Ω–æ" (cancelled):
1. –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ –±—ã–ª–∞ –æ–ø–ª–∞—á–µ–Ω–∞ (—Å—Ç–∞—Ç—É—Å `escrow` –∏–ª–∏ `in_progress`) ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–±–µ–∏–º —Å—Ç–æ—Ä–æ–Ω–∞–º
3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ `cancelled` —Å –ø—Ä–∏—á–∏–Ω–æ–π `admin_cancelled`

## –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é Edge Function `admin-cancel-deal` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç–º–µ–Ω—ã —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `admin-complete-deal`.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤–∞—è Edge Function: `admin-cancel-deal/index.ts`

–õ–æ–≥–∏–∫–∞:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—ã–∑—ã–≤–∞—é—â–∏–π ‚Äî –∞–¥–º–∏–Ω (—á–µ—Ä–µ–∑ `has_role`)
- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–∫–∏, —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è –∏ –∫–∞–Ω–∞–ª–∞
- –ï—Å–ª–∏ –µ—Å—Ç—å `escrow_mnemonic_encrypted` –∏ –∫–æ—à–µ–ª—ë–∫ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–∫–∏ –Ω–∞ `cancelled` —Å –ø—Ä–∏—á–∏–Ω–æ–π `admin_cancelled`
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram –æ–±–µ–∏–º —Å—Ç–æ—Ä–æ–Ω–∞–º

```typescript
// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
async function adminCancelDeal(dealId: string): Promise<Result> {
  // 1. –ü–æ–ª—É—á–∏—Ç—å —Å–¥–µ–ª–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏
  const deal = await getDealWithRelations(dealId);
  
  // 2. –ü–æ–ª—É—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è
  const advertiser = await getAdvertiser(deal.advertiser_id);
  
  // 3. –í–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —ç—Å–∫—Ä–æ—É
  let refundSuccess = false;
  if (advertiser.wallet_address && deal.escrow_mnemonic_encrypted) {
    refundSuccess = await sendRefund(
      deal.escrow_mnemonic_encrypted,
      advertiser.wallet_address
    );
  }
  
  // 4. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
  await supabase.from("deals").update({
    status: "cancelled",
    cancellation_reason: "admin_cancelled",
    updated_at: new Date().toISOString()
  }).eq("id", dealId);
  
  // 5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  await notifyParties(deal, advertiser, owner);
  
  return { success: true, refundSuccess };
}
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å `AdminDealsTable.tsx`

–ü—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ `cancelled` –≤—ã–∑—ã–≤–∞—Ç—å –Ω–æ–≤—É—é Edge Function:

```typescript
const updateStatus = async (dealId: string, newStatus: DealStatus) => {
  if (newStatus === 'completed') {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ - admin-complete-deal
  } else if (newStatus === 'cancelled') {
    // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ - –æ—Ç–º–µ–Ω–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º
    const { data, error } = await supabase.functions.invoke('admin-cancel-deal', {
      body: { dealId }
    });
    
    toast({
      title: '–°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞',
      description: data.refundSuccess 
        ? '–°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é' 
        : '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω',
    });
  } else if (newStatus === 'escrow') {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
  } else {
    // –ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  }
};
```

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤–∏—Ç—å –≤ `supabase/config.toml`:
```toml
[functions.admin-cancel-deal]
verify_jwt = false
```

–°–æ–∑–¥–∞—Ç—å `supabase/functions/admin-cancel-deal/deno.json`:
```json
{
  "imports": {
    "@ton/crypto": "npm:@ton/crypto@3",
    "@ton/ton": "npm:@ton/ton@15"
  }
}
```

## –§–∞–π–ª—ã –∫ —Å–æ–∑–¥–∞–Ω–∏—é/–∏–∑–º–µ–Ω–µ–Ω–∏—é

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|-----------|
| `supabase/functions/admin-cancel-deal/index.ts` | –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º |
| `supabase/functions/admin-cancel-deal/deno.json` | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ TON |
| `supabase/config.toml` | –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ |
| `src/components/admin/AdminDealsTable.tsx` | –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞ `cancelled` |

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é:**
```
‚ùå –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ {channel_title} –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ.
üí∞ –í–æ–∑–≤—Ä–∞—Ç: {total_price} TON –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à –∫–æ—à–µ–ª—ë–∫.
```

**–í–ª–∞–¥–µ–ª—å—Ü—É –∫–∞–Ω–∞–ª–∞:**
```
‚ùå –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª–µ {channel_title} –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π.
–°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é.
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

- –ê–¥–º–∏–Ω –≤—ã–±–∏—Ä–∞–µ—Ç "–û—Ç–º–µ–Ω–µ–Ω–æ" –≤ —Å–µ–ª–µ–∫—Ç–µ
- –ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ –±—ã–ª–∞ –æ–ø–ª–∞—á–µ–Ω–∞ ‚Üí TON –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
- –û–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
- –°–¥–µ–ª–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–º–µ–Ω—ë–Ω–Ω–∞—è —Å –ø—Ä–∏—á–∏–Ω–æ–π `admin_cancelled`

