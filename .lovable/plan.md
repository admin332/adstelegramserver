

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–∞–Ω–∞–ª–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ–≥–¥–∞ –≤–ª–∞–¥–µ–ª–µ—Ü –∫–∞–Ω–∞–ª–∞ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç —Å–¥–µ–ª–∫—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ (–∫–Ω–æ–ø–∫–∞ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–∫–∞–∑"):
- –°—Ç–∞—Ç—É—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `cancelled` 
- –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: "–°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
- **–ù–û –≤–æ–∑–≤—Ä–∞—Ç TON –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç!** –í –∫–æ–¥–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç —ç—Ç–æ–π –ª–æ–≥–∏–∫–∏

## –ì–¥–µ –ø—Ä–æ–±–ª–µ–º–∞

–§–∞–π–ª: `supabase/functions/telegram-webhook/index.ts`

–§—É–Ω–∫—Ü–∏—è `handleDealRejection` (—Å—Ç—Ä–æ–∫–∏ 623-710):
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `cancelled`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–±–µ–∏–º —Å—Ç–æ—Ä–æ–Ω–∞–º
- **–ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤**

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ –≤ `handleDealRejection`, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ñ—É–Ω–∫—Ü–∏–∏ `admin-cancel-deal`:

1. –ü–æ–ª—É—á–∏—Ç—å `escrow_mnemonic_encrypted` –∏–∑ —Å–¥–µ–ª–∫–∏
2. –ü–æ–ª—É—á–∏—Ç—å `wallet_address` —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è
3. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –º–Ω–µ–º–æ–Ω–∏–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å TON –æ–±—Ä–∞—Ç–Ω–æ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
4. –û–±–Ω–æ–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≤–æ–∑–≤—Ä–∞—Ç–∞

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª: `supabase/functions/telegram-webhook/index.ts`

**1. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ TON –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:**
```typescript
import { mnemonicToPrivateKey, KeyPair } from "npm:@ton/crypto@3";
import { WalletContractV4, TonClient, internal, Address } from "npm:@ton/ton@15";
```

**2. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –º–Ω–µ–º–æ–Ω–∏–∫–∏:**
```typescript
async function decryptMnemonic(encryptedData: string): Promise<string[]> {
  // –ö–æ–ø–∏—è –∏–∑ admin-cancel-deal
}
```

**3. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤:**
```typescript
async function refundToAdvertiser(
  escrowMnemonicEncrypted: string, 
  advertiserWalletAddress: string
): Promise<boolean> {
  // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ TON
}
```

**4. –û–±–Ω–æ–≤–∏—Ç—å `handleDealRejection`:**

–í –∑–∞–ø—Ä–æ—Å–µ —Å–¥–µ–ª–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å `escrow_mnemonic_encrypted`:
```typescript
const { data: deal } = await supabase
  .from("deals")
  .select("id, status, channel_id, advertiser_id, total_price, escrow_mnemonic_encrypted")
  .eq("id", dealId)
  .single();
```

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç:
```typescript
// –í–µ—Ä–Ω—É—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
let refundSuccess = false;
const { data: advertiser } = await supabase
  .from("users")
  .select("telegram_id, wallet_address")
  .eq("id", deal.advertiser_id)
  .single();

if (advertiser?.wallet_address && deal.escrow_mnemonic_encrypted) {
  refundSuccess = await refundToAdvertiser(
    deal.escrow_mnemonic_encrypted,
    advertiser.wallet_address
  );
}
```

–û–±–Ω–æ–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é:
```typescript
if (refundSuccess) {
  message = `üí∞ –í–æ–∑–≤—Ä–∞—Ç: <b>${deal.total_price} TON</b> –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à –∫–æ—à–µ–ª—ë–∫.`;
} else {
  message = `üí∞ –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`;
}
```

### –§–∞–π–ª: `supabase/functions/telegram-webhook/deno.json`

–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ TON:
```json
{
  "imports": {
    "@ton/crypto": "npm:@ton/crypto@3",
    "@ton/ton": "npm:@ton/ton@15"
  }
}
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

–¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å `deal-action/index.ts` ‚Äî —Ç–∞–º —Ç–æ–∂–µ –µ—Å—Ç—å `// TODO: Initiate refund process`. –ù–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∏–¥—ë—Ç —á–µ—Ä–µ–∑ `telegram-webhook`, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –Ω–µ–≥–æ.

## –§–∞–π–ª—ã –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|-----------|
| `supabase/functions/telegram-webhook/index.ts` | –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ TON –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ |
| `supabase/functions/telegram-webhook/deno.json` | –°–æ–∑–¥–∞—Ç—å —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ TON |
| `supabase/functions/deal-action/index.ts` | –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Ä–µ—Ñ–∞–Ω–¥–∞ –ø—Ä–∏ reject (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –í–ª–∞–¥–µ–ª–µ—Ü –∫–∞–Ω–∞–ª–∞ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ Telegram ‚Üí TON —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
- –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –≤–æ–∑–≤—Ä–∞—Ç–∞
- –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å cron-job –∏–ª–∏ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∞–¥–º–∏–Ω–∞

