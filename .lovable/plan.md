

# –ü–ª–∞–Ω: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ" ‚Üí "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"

## –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
–ê–Ω–∞–ª–∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ —Å–¥–µ–ª–∫–∞ `a802c68d-...` –∏–º–µ–µ—Ç:
- `posted_at: 2026-01-27 00:00:13`
- `completed_at: 2026-01-27 00:00:13` ‚Äî **—Ç–æ –∂–µ —Å–∞–º–æ–µ –≤—Ä–µ–º—è**!
- `status: completed`

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ **—Ñ—É–Ω–∫—Ü–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ —Å—Ç–∞—Ç—É—Å completed —Å—Ä–∞–∑—É**, –∞ –Ω–µ –æ—Å—Ç–∞–≤–∏–ª–∞ `in_progress` —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º `posted_at`.

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
1. Edge Function `publish-scheduled-posts` –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–µ–ø–ª–æ–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. Cron job –≤—ã–∑–≤–∞–ª –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏
3. Cron job `complete-posted-deals` —Å—Ä–∞–±–æ—Ç–∞–ª —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –∏ –∑–∞–≤–µ—Ä—à–∏–ª —Å–¥–µ–ª–∫—É –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

## –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ß–∞—Å—Ç—å 1: –ü–µ—Ä–µ–¥–µ–ø–ª–æ–∏—Ç—å publish-scheduled-posts
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–µ–ø–ª–æ–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞:
- –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞—ë—Ç—Å—è `in_progress`
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `posted_at`
- `completed_at` –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

### –ß–∞—Å—Ç—å 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å complete-posted-deals
–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è **–Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–∞** —Å–¥–µ–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã:

```text
–ë–´–õ–û: –ù–∞–π—Ç–∏ –≤—Å–µ in_progress —Å posted_at ‚â† null, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è
–ë–£–î–ï–¢: –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞ + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä 1 —á–∞—Å –ø–æ—Å–ª–µ posted_at
```

### –ß–∞—Å—Ç—å 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É–∂–µ —Å–ª–æ–º–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
–ó–∞–ø—É—Å—Ç–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–¥–µ–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—à–∏–±–æ—á–Ω–æ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ `completed` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:

```sql
UPDATE public.deals
SET 
  status = 'in_progress',
  completed_at = NULL
WHERE 
  status = 'completed'
  AND posted_at IS NOT NULL
  AND posted_at = completed_at  -- –ü—Ä–∏–∑–Ω–∞–∫ –æ—à–∏–±–∫–∏: –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
  AND (posted_at + (duration_hours * INTERVAL '1 hour')) > NOW();
```

–≠—Ç–æ –≤–µ—Ä–Ω—ë—Ç —Å–¥–µ–ª–∫–∏ –≤ —Å—Ç–∞—Ç—É—Å `in_progress`, –∏ —Ç–∞–π–º–µ—Ä "–¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è" –Ω–∞—á–Ω—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

### –ß–∞—Å—Ç—å 4: UI —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
–ö–æ–¥ `DealCard.tsx` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- `dynamicStatusLabel` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ" –∫–æ–≥–¥–∞ `in_progress + posted_at`
- `showCompletionCountdown` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
- `DealCountdown` —Å –º–µ—Ç–∫–æ–π "–¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è"

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|------|----------|
| `supabase/functions/publish-scheduled-posts/index.ts` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø–µ—Ä–µ–¥–µ–ø–ª–æ–∏—Ç—å |
| `supabase/functions/complete-posted-deals/index.ts` | –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ |
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–º–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ |

## –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [–ê–≤–∞—Ç–∞—Ä]  –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞           23:48  ‚îÇ  ‚Üê –¢–∞–π–º–µ—Ä "–¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è"
‚îÇ            @username                –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è‚îÇ
‚îÇ            –ö–∞–º–ø–∞–Ω–∏—è: ...                    ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  üíé 10 TON ‚âà $15.20  ‚Ä¢  1 –ø–æ—Å—Ç  ‚Ä¢  24—á     ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ  üü¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ                  5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ complete-posted-deals

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä - –Ω–µ –∑–∞–≤–µ—Ä—à–∞—Ç—å —Å–¥–µ–ª–∫–∏ —Ä–∞–Ω—å—à–µ —á–µ–º —á–µ—Ä–µ–∑ 1 —á–∞—Å –ø–æ—Å–ª–µ posted_at
const MIN_BUFFER_HOURS = 1;

for (const deal of deals) {
  const postedAt = new Date(deal.posted_at);
  const minWaitTime = new Date(postedAt.getTime() + MIN_BUFFER_HOURS * 60 * 60 * 1000);
  const completionTime = new Date(postedAt.getTime() + deal.duration_hours * 60 * 60 * 1000);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—à–ª–æ –º–∏–Ω–∏–º—É–º 1 —á–∞—Å –ò –∏—Å—Ç—ë–∫ duration_hours
  if (now >= completionTime && now >= minWaitTime) {
    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–¥–µ–ª–∫—É
  }
}
```

### SQL –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
–ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–µ–¥–µ–ø–ª–æ—è —Ñ—É–Ω–∫—Ü–∏–π, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –Ω–µ–¥–∞–≤–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å.

