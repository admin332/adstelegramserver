

## План: Управление Cron Jobs в панели администратора

### Текущие Cron Jobs

| ID | Название | Расписание | Описание |
|----|----------|------------|----------|
| 1 | check-escrow-payments | `*/5 * * * *` | Проверка платежей (каждые 5 мин) |
| 3 | publish-scheduled-posts | `0 * * * *` | Публикация постов (каждый час) |
| 4 | auto-refund-expired-deals | `30 * * * *` | Возврат за истёкшие сделки |
| 5 | complete-posted-deals | `15 * * * *` | Завершение опубликованных сделок |
| 6 | verify-post-integrity | `30 */4 * * *` | Проверка целостности постов |
| 7 | auto-timeout-deals | `30 * * * *` | Таймаут просроченных сделок |

### Новый функционал

1. **Карточка "Cron Jobs"** в настройках админки
2. **Мастер-переключатель** — включить/выключить все jobs одной кнопкой
3. **Таблица всех jobs** с возможностью:
   - Видеть текущее расписание
   - Редактировать расписание (cron-выражение)
   - Включать/выключать каждый job отдельно

```text
┌─────────────────────────────────────────────────────────────────┐
│  ⏰ Планировщик задач (Cron Jobs)                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [ 🔘 Все задачи: ВКЛ ]  ← Мастер-переключатель                │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Название              │ Расписание   │ Статус │ Действия│   │
│  ├───────────────────────┼──────────────┼────────┼─────────│   │
│  │ check-escrow-payments │ */5 * * * *  │ 🟢 Вкл │ ✏️ 🔘   │   │
│  │ publish-scheduled     │ 0 * * * *    │ 🟢 Вкл │ ✏️ 🔘   │   │
│  │ auto-refund-expired   │ 30 * * * *   │ 🟢 Вкл │ ✏️ 🔘   │   │
│  │ complete-posted       │ 15 * * * *   │ 🟢 Вкл │ ✏️ 🔘   │   │
│  │ verify-post-integrity │ 30 */4 * * * │ 🟢 Вкл │ ✏️ 🔘   │   │
│  │ auto-timeout-deals    │ 30 * * * *   │ 🟢 Вкл │ ✏️ 🔘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Техническая реализация

### 1. Новая Edge Function: `manage-cron-admin`

Создать edge function для безопасного управления cron jobs (только для админов):

```typescript
// supabase/functions/manage-cron-admin/index.ts

// Действия:
// - list: получить список всех cron jobs
// - toggle: включить/выключить конкретный job
// - toggle_all: включить/выключить все jobs
// - update_schedule: изменить расписание job

// Проверка прав: только пользователи с ролью admin
```

**Почему edge function?**
- Безопасность: прямой доступ к `cron.job` требует service_role
- Валидация: проверка прав администратора
- Логирование: отслеживание изменений

---

### 2. Обновить функцию `manage_cron_jobs` в БД

Расширить существующую функцию или создать новую `admin_manage_cron_jobs`:

```sql
-- Новые действия:
-- 'list' - получить все jobs
-- 'toggle' - переключить конкретный job (params: jobid, active)
-- 'toggle_all' - переключить все jobs (params: active)
-- 'update_schedule' - изменить расписание (params: jobid, schedule)
```

---

### 3. Новый хук: `useCronJobs`

```typescript
// src/hooks/useCronJobs.ts

interface CronJob {
  jobid: number;
  jobname: string;
  schedule: string;
  active: boolean;
}

export function useCronJobs() {
  // Загрузка списка jobs
  // Функции для toggle/update
  // Состояние загрузки и ошибок
}
```

---

### 4. Новый компонент: `CronJobsManager`

```typescript
// src/components/admin/CronJobsManager.tsx

// UI для управления cron jobs:
// - Мастер-переключатель
// - Таблица с jobs
// - Диалог редактирования расписания
```

---

### 5. Интеграция в `AdminSettings.tsx`

Добавить новую карточку "Планировщик задач" после секции "База данных"

---

## Файлы для создания/изменения

| Файл | Действие | Описание |
|------|----------|----------|
| `supabase/functions/manage-cron-admin/index.ts` | Создать | Edge function для управления cron |
| `src/hooks/useCronJobs.ts` | Создать | Хук для работы с cron jobs |
| `src/components/admin/CronJobsManager.tsx` | Создать | UI компонент управления |
| `src/components/admin/AdminSettings.tsx` | Изменить | Добавить CronJobsManager |
| Миграция БД | Создать | Расширить функцию manage_cron_jobs |

---

## Описание cron-расписаний для UI

| Выражение | Описание |
|-----------|----------|
| `*/5 * * * *` | Каждые 5 минут |
| `0 * * * *` | В начале каждого часа |
| `15 * * * *` | На 15-й минуте каждого часа |
| `30 * * * *` | На 30-й минуте каждого часа |
| `30 */4 * * *` | Каждые 4 часа на 30-й минуте |

---

## Безопасность

1. **Edge function** проверяет JWT токен и роль `admin`
2. **RLS политики** не нужны — работа через service_role
3. **Логирование** всех изменений для аудита

