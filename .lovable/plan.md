
## Цель
Сделать так, чтобы переключатель “Показывать в приложении” **не удалял канал**, а **только деактивировал публикацию**:
- канал **не виден** в каталоге/покупателям и **нельзя заказать рекламу** (если `is_active = false`)
- канал **всегда виден владельцу и менеджерам** в “Мои каналы”, даже если выключен

Сейчас у вас ощущение “удалился”, потому что после выключения канал становится невидимым и владельцу/менеджеру — не из‑за удаления, а из‑за доступа/авторизации.

---

## Что я выяснил по текущей реализации (почему проблема осталась)
1) Переключатель вызывает backend-функцию `update-channel-status`, она делает **UPDATE channels.is_active** (не DELETE). То есть канал физически не удаляется.

2) Но “Мои каналы” сейчас читаются **напрямую из таблиц** (`channels`, `channel_admins`) через клиентский SDK, а доступ к этим таблицам ограничен политиками, которые завязаны на `auth.uid()`.

3) В вашем Telegram‑входе `AuthContext` делает `telegram-auth`, который **создаёт/обновляет запись в таблице `users`**, но **не создаёт серверную сессию входа** (нет “настоящей” авторизации в backend, где появился бы `auth.uid()`).
   - В результате запросы к таблицам идут как “гость” (без `auth.uid()`), и когда канал выключен, он перестаёт попадать в “публичную” часть условия — и исчезает из UI у всех (включая владельца/менеджера).

4) Дополнительно: в `channels.owner_id` и `channel_admins.user_id` используется `users.id` (ваша внутренняя таблица пользователей), а политики написаны через `auth.uid()` (другой идентификатор). Даже если бы была сессия, это потенциально несовместимо.

Вывод: нужно **не пытаться читать приватные таблицы напрямую** без настоящей backend‑сессии, а получать “Мои каналы” через защищённую backend‑функцию по Telegram `initData` (как у вас уже сделано для переключателя статуса).

---

## Решение (высокоуровневое)
### A) Для “Мои каналы” — читать через backend‑функцию по Telegram initData
- Добавим новую backend‑функцию `user-channels`:
  - валидирует Telegram `initData`
  - находит `users.id` по `telegram_id`
  - достаёт список каналов из `channel_admins` + данные из `channels` (включая `is_active`)
  - возвращает всё в UI
- Обновим `useUserChannels()` так, чтобы он **не делал прямые SELECT в таблицы**, а вызывал `.../functions/v1/user-channels`.

Это гарантирует:
- владелец/менеджер видит канал даже если он выключен
- переключатель выключения не “прячет канал навсегда” из списка управления

### B) Для публичного каталога — разрешить чтение только активных/верифицированных каналов
Чтобы каталог/поиск показывали реальные каналы без авторизации:
- добавим/изменим политику SELECT на `channels` для публичного чтения **только** `is_active = true AND verified = true`
- либо оставим каталог на backend‑функции (но проще и нормально безопасно сделать публичный SELECT, так как в `channels` нет чувствительных данных)

---

## План работ (по шагам)

### 1) Backend: создать функцию `user-channels`
**Файл**: `supabase/functions/user-channels/index.ts` (новый)
- Повторить проверку `initData` (как в `update-channel-status` / `verify-channel`)
- По `telegram_id` получить `users.id`
- Выбрать из `channel_admins` записи пользователя: `channel_id`, `role`
- Выбрать из `channels` данные по этим `channel_id` (включая `is_active`, `verified`, `title`, `username`, `avatar_url`, `subscribers_count`, `category`)
- Вернуть массив каналов, где каждому каналу добавить `userRole` из `channel_admins`

**Важно по безопасности**
- доступ только через валидный Telegram `initData`
- выполнение через service key (как у вас уже сделано в других функциях)

### 2) Frontend: перевести `useUserChannels` на вызов backend‑функции
**Файл**: `src/hooks/useUserChannels.ts`
- Вместо прямого `.from("channel_admins") / .from("channels")`:
  - взять `initData` через `getTelegramInitData()`
  - если нет `initData` → вернуть пустой список и показать понятное сообщение (например “Откройте приложение в Telegram”)
  - fetch в `.../functions/v1/user-channels` с `initData` в body
  - вернуть данные в формате `UserChannel[]`

Плюс: после успешного `useToggleChannelActive` делать `invalidateQueries(["user-channels"])` (у вас уже есть), и канал останется в списке, но с `is_active=false`.

### 3) UI: визуально показывать “Канал выключен”, но не убирать его
**Файл**: `src/components/create/MyChannelsList.tsx`
- Если `channel.is_active === false`:
  - показать бейдж “Скрыт” / “Выключен”
  - (опционально) затемнить карточку
- Переключатель остаётся и меняет только `is_active`.

### 4) База данных: сделать публичный каталог корректным (чтобы “никто не видел канал и не мог заказать”)
**Миграция SQL**
- Добавить отдельную политику SELECT на `channels` для `public/anon`:
  - разрешить SELECT только для строк `(is_active = true AND verified = true)`
- При этом оставить приватный доступ через backend‑функции для владельцев/менеджеров (а не через прямой SELECT).

Примечание: это решит и проблему “в каталоге ничего нет кроме моков”, потому что сейчас чтение таблицы из каталога может быть заблокировано без авторизации.

### 5) Заказ рекламы: дополнительно заблокировать оформление заказа на выключенный канал
Даже если канал вдруг открывается по прямой ссылке:
- В UI `OrderDrawer` / странице канала добавить проверку `channel.is_active`:
  - если `false` → кнопка заказа disabled + текст “Канал временно скрыт, реклама недоступна”
- (Если создание заказа идёт через backend‑функцию — добавить серверную проверку там тоже.)

---

## Что будет в итоге (ожидаемое поведение)
- Менеджер/владелец:
  - всегда видит канал в “Мои каналы”
  - может включать/выключать — канал не пропадает из списка управления
- Покупатель/публичный пользователь:
  - не видит выключенный канал в каталоге
  - не может заказать рекламу на выключенный канал

---

## Риски и важные замечания
- Ранее уже были правки в auto-generated файле типов (`src/integrations/supabase/types.ts`). Дальше я это трогать не буду (это должно быть автогенерируемым).
- Если у вас есть сценарий “управление каналами НЕ из Telegram” (в обычном браузере) — нужно отдельно обсудить, потому что Telegram `initData` там не будет, и “Мои каналы” логично не покажутся.

---

## Проверка после внедрения (чеклист)
1) Добавить канал как менеджер → он появляется в “Мои каналы”
2) Выключить переключателем → канал остаётся в “Мои каналы”, появляется “Скрыт”, в каталоге исчезает
3) Включить обратно → возвращается в каталог
4) Попытаться заказать рекламу на выключенном → заказ недоступен

