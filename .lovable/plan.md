

## –ü–ª–∞–Ω: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–≤—Ä–∞—Ç—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞ + –ª–∏–º–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤

| –°—Ü–µ–Ω–∞—Ä–∏–π | –£—Å–ª–æ–≤–∏–µ | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
|----------|---------|---------------|
| –í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç 24—á –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã | –ù–µ –æ–¥–æ–±—Ä–∏–ª/–Ω–µ –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É | 100% ‚Üí —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é |
| –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç 24—á –ø–æ—Å–ª–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ | –ù–µ –æ–¥–æ–±—Ä–∏–ª/–Ω–µ –∑–∞–ø—Ä–æ—Å–∏–ª –¥–æ—Ä–∞–±–æ—Ç–∫—É | 70% ‚Üí —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é, 30% ‚Üí –≤–ª–∞–¥–µ–ª—å—Ü—É |
| –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ (3) | revision_count >= 3 | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É" |

---

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:

```sql
ALTER TABLE deals ADD COLUMN draft_submitted_at TIMESTAMPTZ DEFAULT NULL;
```

–≠—Ç–æ –ø–æ–ª–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–∞–Ω–∞–ª–∞.

---

### 2. –ù–æ–≤–∞—è Edge Function: `auto-timeout-deals/index.ts`

–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ cron –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–≤–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è:

**–°—Ü–µ–Ω–∞—Ä–∏–π A: –í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç 24—á –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã**
- –£—Å–ª–æ–≤–∏—è: `status = 'escrow'`, `payment_verified_at < now() - 24 hours`, `author_draft IS NULL` (—á–µ—Ä–Ω–æ–≤–∏–∫ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω)
- –î–µ–π—Å—Ç–≤–∏–µ: 100% –≤–æ–∑–≤—Ä–∞—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é, –æ—Ç–º–µ–Ω–∞ —Å–¥–µ–ª–∫–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π B: –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç 24—á –ø–æ—Å–ª–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞**
- –£—Å–ª–æ–≤–∏—è: `status = 'escrow'`, `draft_submitted_at < now() - 24 hours`, `is_draft_approved IS NULL`
- –î–µ–π—Å—Ç–≤–∏–µ: 
  - 70% ‚Üí —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å
  - 30% ‚Üí –≤–ª–∞–¥–µ–ª–µ—Ü –∫–∞–Ω–∞–ª–∞
  - –û—Ç–º–µ–Ω–∞ —Å–¥–µ–ª–∫–∏

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `submit-draft/index.ts`

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `draft_submitted_at = now()`:

```typescript
const { error: updateError } = await supabase
  .from("deals")
  .update({
    author_draft: draftText,
    author_draft_media_urls: draftMediaUrls || [],
    is_draft_approved: null,
    draft_submitted_at: new Date().toISOString(), // ‚Üê –î–û–ë–ê–í–ò–¢–¨
  })
  .eq("id", dealId);
```

---

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ webhook –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `draft_submitted_at`

–í —Ñ—É–Ω–∫—Ü–∏–∏ `handleDraftMessage` –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —á–µ—Ä–µ–∑ –±–æ—Ç —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `draft_submitted_at`.

---

### 5. –õ–∏–º–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ (–º–∞–∫—Å–∏–º—É–º 3)

**–í review-draft/index.ts:**
```typescript
if (action === "request_revision" && deal.revision_count >= 3) {
  return Response({ 
    success: false, 
    error: "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ (–º–∞–∫—Å–∏–º—É–º 3)" 
  });
}
```

**–í telegram-webhook/index.ts (handleDraftRevision):**
```typescript
const { data: deal } = await supabase
  .from("deals")
  .select("id, revision_count")
  .eq("id", dealId)
  .single();

if ((deal?.revision_count || 0) >= 3) {
  await answerCallbackQuery(callbackQueryId, "–õ–∏–º–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω (3)");
  return;
}
```

**–í DraftReviewDialog.tsx:**
```typescript
const maxRevisions = 3;
const canRequestRevision = revisionCount < maxRevisions;

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
{revisionCount === 2 && (
  <p className="text-yellow-500 text-xs">
    ‚ö†Ô∏è –û—Å—Ç–∞–ª–∞—Å—å –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞
  </p>
)}

// –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –ª–∏–º–∏—Ç
{canRequestRevision && (
  <Button onClick={() => setShowRevisionInput(true)}>
    –ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
  </Button>
)}
```

---

### 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –Ω–æ–≤—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏

**notify-deal-payment/index.ts ‚Äî –≤–ª–∞–¥–µ–ª—å—Ü—É –∫–∞–Ω–∞–ª–∞:**
```
‚úÖ <b>–†–µ–∫–ª–∞–º–∞ –æ–ø–ª–∞—á–µ–Ω–∞!</b>

...

‚è∞ <b>–í–∞–∂–Ω–æ:</b> –ü—Ä–∏–º–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤, –∏–Ω–∞—á–µ —Å–¥–µ–ª–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ä–µ–¥—Å—Ç–≤ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é.
```

**check-escrow-payments/index.ts ‚Äî —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é:**
```
üí≥ <b>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</b>

...

‚è∞ <b>–í–∞–∂–Ω–æ:</b> –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —É –≤–∞—Å 24 —á–∞—Å–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É. –ï—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç–µ ‚Äî 70% –≤–µ—Ä–Ω—ë—Ç—Å—è –≤–∞–º, 30% –ø–æ–ª—É—á–∏—Ç –∞–≤—Ç–æ—Ä –∑–∞ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É.
```

**submit-draft/index.ts ‚Äî —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:**
```
üìù <b>–ß–µ—Ä–Ω–æ–≤–∏–∫ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</b>

...

‚è∞ –£ –≤–∞—Å –µ—Å—Ç—å 24 —á–∞—Å–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (70% –≤–∞–º, 30% –∞–≤—Ç–æ—Ä—É).
```

**telegram-webhook/index.ts ‚Äî –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:**
```
üìù <b>–ß–µ—Ä–Ω–æ–≤–∏–∫ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</b>

...

‚è∞ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.
–ú–∞–∫—Å–∏–º—É–º 3 –¥–æ—Ä–∞–±–æ—Ç–∫–∏.
```

---

### 7. Cron job –¥–ª—è auto-timeout-deals

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π cron job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤:

```sql
SELECT cron.schedule(
  'auto-timeout-deals',
  '45 * * * *', -- –∫–∞–∂–¥—ã–π —á–∞—Å –≤ :45
  $$
  SELECT net.http_post(
    url:='https://fdxyittddmpyhaiijddp.supabase.co/functions/v1/auto-timeout-deals',
    headers:='{"Authorization": "Bearer ...", "Content-Type": "application/json"}'::jsonb,
    body:='{}'::jsonb
  );
  $$
);
```

---

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|-----------|
| **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** | –î–æ–±–∞–≤–∏—Ç—å `draft_submitted_at` |
| `supabase/functions/auto-timeout-deals/index.ts` | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é |
| `supabase/functions/submit-draft/index.ts` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `draft_submitted_at` |
| `supabase/functions/telegram-webhook/index.ts` | –õ–∏–º–∏—Ç 3 –¥–æ—Ä–∞–±–æ—Ç–æ–∫, `draft_submitted_at` |
| `supabase/functions/review-draft/index.ts` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –¥–æ—Ä–∞–±–æ—Ç–æ–∫ |
| `supabase/functions/notify-deal-payment/index.ts` | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ 24—á |
| `supabase/functions/check-escrow-payments/index.ts` | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |
| `src/components/deals/DraftReviewDialog.tsx` | –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –ª–∏–º–∏—Ç–µ |
| `supabase/config.toml` | –î–æ–±–∞–≤–∏—Ç—å `auto-timeout-deals` |

---

### –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ (70/30)

–ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è:

```typescript
const totalNano = balance; // –ë–∞–ª–∞–Ω—Å —ç—Å–∫—Ä–æ—É –≤ nanoTON
const networkFee = BigInt(0.04 * 1_000_000_000); // 0.04 TON –Ω–∞ 2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const availableAmount = totalNano - networkFee;

const ownerShare = availableAmount * 30n / 100n;
const advertiserShare = availableAmount - ownerShare; // ~70%

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å 30% –≤–ª–∞–¥–µ–ª—å—Ü—É
await sendTransfer(ownerWalletAddress, ownerShare, "Adsingo - —Ä–∞–±–æ—Ç–∞ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞");

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å 70% —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
await sendTransfer(advertiserWalletAddress, advertiserShare, "Adsingo - —á–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç");
```

---

### –ò—Ç–æ–≥–æ–≤—ã–π —Ñ–ª–æ—É

```text
–û–ø–ª–∞—Ç–∞ ‚Üí payment_verified_at = now()
  ‚îú‚îÄ 24—á –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–ª—á–∏—Ç ‚Üí 100% —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é
  ‚îî‚îÄ –í–ª–∞–¥–µ–ª–µ—Ü –ø–∏—à–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ ‚Üí draft_submitted_at = now()
       ‚îú‚îÄ 24—á —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –º–æ–ª—á–∏—Ç ‚Üí 70% —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—é, 30% –≤–ª–∞–¥–µ–ª—å—Ü—É
       ‚îú‚îÄ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä—è–µ—Ç ‚Üí in_progress ‚Üí –ø—É–±–ª–∏–∫–∞—Ü–∏—è
       ‚îî‚îÄ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É (max 3) ‚Üí –Ω–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫
            ‚îî‚îÄ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ...
```

